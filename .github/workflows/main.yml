name: Scraping & Enrichment Pipeline

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  scrape-and-transform:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4. Run header organizer
      - name: Run header organizer
        run: node scripts/header-organizer.js
        continue-on-error: false

      # 5. Run webpage inspector
      - name: Run webpage inspector
        run: node scripts/webpage-inspector.js
        continue-on-error: false

      # 6. Run mapping scraper
      - name: Run mapping scraper
        run: node scripts/mapping-scraper.js
        continue-on-error: false

      # 7. Upload parsed auctions artifact
      - name: Upload parsed auctions
        uses: actions/upload-artifact@v4
        with:
          name: parsed-auctions
          path: artifacts/parsed-auctions.json

      # 8. Bridge parsed-auctions.json â†’ legacy raw-scrape.json
      - name: Transform to legacy schema
        run: node scripts/bridge-transform.js artifacts/parsed-auctions.json artifacts/raw-scrape.json

      # 9. Upload legacy raw-scrape artifact
      - name: Upload raw scrape
        uses: actions/upload-artifact@v4
        with:
          name: raw-scrape
          path: artifacts/raw-scrape.json

      # 10. Run schema validation
      - name: Validate schema
        run: node scripts/schema-validator.js artifacts/raw-scrape.json

      # 11. Upload logs for transparency
      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs
          path: logs/