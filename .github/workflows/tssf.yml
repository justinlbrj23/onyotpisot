name: TSSF Worksheet Automation

on:
  workflow_dispatch:

jobs:
  tssf_pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Show Node / NPM versions and repo root
        run: |
          node -v
          npm -v
          pwd
          ls -la

      - name: Restore npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (ci if lockfile present)
        run: |
          if [ -f package-lock.json ]; then
            echo "Lockfile found: using npm ci"
            npm ci --no-audit --no-fund
          else
            echo "No lockfile: using npm install (consider committing package-lock.json)"
            npm install --no-audit --no-fund
          fi
          # Ensure a pinned pdfjs-dist is available (idempotent)
          if ! npm ls pdfjs-dist >/dev/null 2>&1; then
            echo "pdfjs-dist not found in installed deps â€” installing pinned version"
            npm install pdfjs-dist@^4.0.269 --no-audit --no-fund
          else
            echo "pdfjs-dist already installed"
          fi
          # Ensure pdf-lib and pdf-parse are present (idempotent)
          npm install pdf-lib pdf-parse --no-audit --no-fund

      - name: List installed pdfjs-dist files (diagnostic)
        run: |
          echo "pdfjs-dist listing (if present):"
          npm ls pdfjs-dist || true
          if [ -d node_modules/pdfjs-dist ]; then
            echo "Top-level files in node_modules/pdfjs-dist:"
            ls -la node_modules/pdfjs-dist | sed -n '1,200p'
            echo "legacy/build (if present):"
            ls -la node_modules/pdfjs-dist/legacy/build || true
            echo "build (if present):"
            ls -la node_modules/pdfjs-dist/build || true
          else
            echo "node_modules/pdfjs-dist not found"
          fi

      - name: Try resolving common pdfjs-dist entry paths (diagnostic)
        shell: bash
        run: |
          node -e "try{console.log('resolve legacy/build/pdf.js ->', require.resolve('pdfjs-dist/legacy/build/pdf.js'))}catch(e){console.error('legacy/build/pdf.js not resolvable:', e.message)}"
          node -e "try{console.log('resolve build/pdf.js ->', require.resolve('pdfjs-dist/build/pdf.js'))}catch(e){console.error('build/pdf.js not resolvable:', e.message)}"
          node -e "try{console.log('resolve build/pdf ->', require.resolve('pdfjs-dist/build/pdf'))}catch(e){console.error('build/pdf not resolvable:', e.message)}"

      - name: Run fillWorksheet.cjs
        env:
          NODE_OPTIONS: "--no-warnings"
        run: |
          pwd
          ls -la
          node fillWorksheet.cjs

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tssf-artifacts
          path: |
            filled_worksheet.pdf
            parsed-summary.txt
            parsed-summary.json
            anchors-debug.json